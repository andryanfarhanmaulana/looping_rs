# Looping_RS: Симулятор работы ноды-валидатора в PoS-сети

## Концепция

**Looping_RS** — это программный симулятор, разработанный для демонстрации и изучения ключевых принципов работы валидатора в блокчейн-сети, использующей консенсус **Proof-of-Stake (PoS)**. Проект не является реальной криптовалютной нодой, а представляет собой образовательный инструмент в виде одного Python-скрипта, имитирующего сложную децентрализованную систему в контролируемой среде.

Основная задача симулятора — наглядно показать жизненный цикл валидатора:

*   **Синхронизация с сетью:** Получение транзакций и блоков от других участников.
*   **Управление мемпулом:** Хранение и обработка неподтвержденных транзакций.
*   **Создание блоков:** Формирование нового блока, когда наступает очередь валидатора.
*   **Криптографическая подпись:** Использование пар ключей (приватный/публичный) для подписи блоков и подтверждения их подлинности.
*   **Валидация блоков:** Проверка блоков, предложенных другими валидаторами, на соответствие правилам консенсуса.
*   **Поддержание локальной копии блокчейна:** Добавление валидных блоков в свою цепь.

Симуляция использует асинхронный подход (`asyncio`) для имитации одновременных сетевых событий и конкурентных задач, что делает её поведение более реалистичным.

## Архитектура кода

Скрипт имеет модульную архитектуру, где каждый компонент отвечает за свою часть логики. Это упрощает понимание, тестирование и возможное расширение функционала.

### Ключевые классы:

*   `Transaction`: Простая структура данных (`dataclass`) для представления транзакции. Включает методы для создания хэша и криптографической подписи.

*   `Block`: `dataclass`, представляющий блок. Содержит заголовок (высота, временная метка, хэш предыдущего блока), список транзакций и подпись валидатора. Также имеет методы для вычисления собственного хэша и подписи.

*   `Mempool`: Класс для управления пулом неподтвержденных транзакций. Реализует логику добавления, извлечения и удаления транзакций.

*   `Blockchain`: Управляет локальной копией цепочки блоков. Отвечает за добавление новых блоков и базовую проверку их целостности (высота, связь с предыдущим блоком).

*   `P2PNetworkSimulator`: Имитирует P2P-сеть. Отвечает за "трансляцию" (broadcast) блоков и транзакций всем зарегистрированным валидаторам с искусственной сетевой задержкой.

*   `Validator`: Центральный класс, объединяющий все компоненты. Каждый объект этого класса представляет собой отдельного валидатора со своей парой ключей, локальным блокчейном и мемпулом. Основная логика валидатора заключена в его методах:
    *   `create_block()`: Формирует новый блок.
    *   `validate_and_process_block()`: Проверяет подпись и структуру полученного блока.
    *   `process_events()`: Асинхронный цикл, обрабатывающий входящие события (новые транзакции, новые блоки) из очереди.

### Поток данных:

1.  **Генератор транзакций** (`transaction_generator`) создает новую транзакцию.
2.  Транзакция через `P2PNetworkSimulator` рассылается всем `Validator`'ам.
3.  Каждый `Validator` получает транзакцию и добавляет её в свой `Mempool`.
4.  Основной цикл симуляции (`main`) определяет, чья сейчас очередь предлагать блок (используется простой Round-Robin).
5.  Выбранный `Validator`-пропозер вызывает `create_block()`, упаковывая транзакции из своего `Mempool`.
6.  Созданный блок подписывается приватным ключом валидатора.
7.  Блок транслируется через `P2PNetworkSimulator` остальным валидаторам.
8.  Каждый `Validator` получает блок, проверяет его с помощью `validate_and_process_block()` и, в случае успеха, добавляет в свой `Blockchain` и очищает соответствующие транзакции из `Mempool`.

## Принцип работы

1.  **Инициализация:**
    *   Создается P2P-сеть и генезис-блок (нулевой блок).
    *   Создается заданное в конфигурации (`SIMULATION_CONFIG`) количество валидаторов. Каждому генерируется уникальная пара ECDSA-ключей.
    *   Каждый валидатор инициализируется с генезис-блоком в своей цепи.

2.  **Запуск процессов:**
    *   Для каждого валидатора запускается асинхронная задача `process_events`, которая слушает очередь входящих событий.
    *   Запускается отдельная асинхронная задача `transaction_generator`, которая с заданной периодичностью создает случайные транзакции и рассылает их по сети.

3.  **Цикл производства блоков:**
    *   Симуляция работает дискретными временными интервалами, "слотами", длительность которых определяется параметром `BLOCK_TIME_SECONDS`.
    *   В каждом слоте, на основе номера текущего блока, по алгоритму Round-Robin (`(block_height - 1) % num_validators`) выбирается один валидатор-пропозер.
    *   Пропозер создает блок, подписывает его и рассылает всем остальным.
    *   Остальные валидаторы получают, проверяют и добавляют блок в свои цепи.
    *   Процесс логируется в консоль, отображая, какой валидатор предлагает блок, сколько в нем транзакций и как другие валидаторы его обрабатывают.

4.  **Завершение:**
    *   Симуляция завершается после создания заданного количества блоков (`SIMULATION_DURATION_BLOCKS`).
    *   В конце выводится итоговая высота блокчейна для каждого валидатора, чтобы убедиться, что все они находятся в консенсусе.

## Пример использования

### 1. Подготовка окружения

Для запуска скрипта требуется Python 3.7+ и несколько внешних библиотек. Рекомендуется использовать виртуальное окружение.

```bash
# Создать виртуальное окружение
python -m venv venv

# Активировать его
# Windows
# .\venv\Scripts\activate
# macOS / Linux
source venv/bin/activate

# Установить зависимости
pip install -r requirements.txt
```

### 2. Запуск симуляции

Просто запустите Python-скрипт.

```bash
python script.py
```

### 3. Ожидаемый вывод

Вы увидите в консоли логи работы симулятора. Они показывают инициализацию валидаторов, старт симуляции и последовательное создание блоков.

```
2023-10-27 15:30:00 - INFO - [PoS_Simulator] - --- Starting Proof-of-Stake Validator Simulation ---
2023-10-27 15:30:00 - INFO - [Validator-0xabc123] - Initialized with address 0xabc123...
2023-10-27 15:30:00 - INFO - [Validator-0xdef456] - Initialized with address 0xdef456...
...

2023-10-27 15:30:00 - INFO - [PoS_Simulator] - 
--- Block Slot 1 | Proposer: 0xabc123... ---
2023-10-27 15:30:05 - INFO - [Validator-0xabc123] - Created and signed new block 1 with 8 transactions.
2023-10-27 15:30:05 - INFO - [Node 0xabc123] - broadcasting block 1
2023-10-27 15:30:05 - INFO - [Validator-0xdef456] - Received block 1 from 0xabc123...
2023-10-27 15:30:05 - INFO - [Validator-0xdef456] - Validated and added block 1. Chain height is now 1.
...

2023-10-27 15:30:05 - INFO - [PoS_Simulator] - 
--- Block Slot 2 | Proposer: 0xdef456... ---
...
```
